<?xml version="1.0" encoding="UTF-8"?>
<rules
  xmlns="http://namespaces.plone.org/diazo"
  xmlns:css="http://namespaces.plone.org/diazo/css"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

  <rules css:if-content="#visual-portal-wrapper">

    <!--Plone.app.toolbar-->
    <append theme="/html/body" content="//div[@data-iframe='toolbar']"/>

    <!--Head-->
    <copy css:content="html" css:theme="html" attributes="lang dir"/>
    <drop css:theme="head script" css:if-content=".template-sat"/>
    <before css:content="head style, head link, head script, head meta" css:theme-children="head"/>
    <replace css:content="head title" css:theme="head title"/>
    <copy css:content="head base" css:theme="head base"/>
    <drop css:content="head link[rel='shortcut icon']"/>
    <drop css:content="head link[rel='apple-touch-icon']"/>

    <!--Content-->
    <merge attributes="class" css:content="body" css:theme="body"/>
    <copy attributes="id dir" css:content="body" css:theme="body"/>
    <copy attributes="role" css:content="content" css:theme="contentspace"/>

    <rules css:if-content=".section-frontpage.template-standard">
      <theme href="index.html" />
      <replace css:content-children=".fp-news-tile" css:theme-children=".fp-news-tile" />
      <replace css:content-children=".fp-events-tile" css:theme-children=".fp-events-tile" />
      <replace css:theme-children="#t-countries" css:content="#fp-country-selector"  />

      <!-- slider -->
      <replace css:theme=".slider" css:content=".slider" href="/@@slides-frontpage" method="document" />
      <replace css:theme=".db-categories" css:content=".db-categories" href="@@fp-search-dynamic" method="document"/>
    </rules>

    <rules css:if-not-content=".section-frontpage.template-standard">
      <theme href="page.html" />
    </rules>


    <replace css:content="#portal-columns" css:theme="#page-body"/>
    <replace css:content="#navbar" css:theme=".main-nav-menu" href="@@site_navbar" method="document"/>

    <!-- top menu help section -->
    <replace css:theme-children="#help-items" css:content="#help-navbar" href="@@help-nav" css:theme=".help-nav-menu" method="document"/>

    <drop attributes="class" css:content="#portal-columns" />
    <!-- <drop attributes="class" css:content="#portal-column-content" /> -->

    <!--Viewlets-->
    <!-- <replace css:content="#portal-personaltools" css:theme="#user"/> -->
    <!-- <copy attributes="href title" css:content="#portal-logo" css:theme="#logo a"/> -->
    <!-- <replace css:content="#portal-header p.hiddenStructure" css:theme="#accessibility"/> -->
    <!-- <drop css:content=".searchSection"/> -->
    <!-- <replace css:content="#portal-searchbox" css:theme="#search"/> -->
    <!--  -->


    <!-- <replace css:content-children="#portal-footer" css:theme="#footer-info"/> -->
    <!-- <replace css:content="#portal-siteactions" css:theme-children="#siteactions"/> -->
    <!-- <after css:content="#portal-languageselector" css:theme="#logo"/> -->

    <!-- <after css:content="#visual-portal-wrapper .row:last-child script" css:theme="head script:last-child"/> -->
    <after css:content="#visual-portal-wrapper script[data-diazo='matomo-analytics']" css:theme-children='body'/>

    <!-- Global Search box -->
    <copy attributes="action method" css:content="#portal-searchbox form" css:theme=".search-box form" />

    <!-- Personal menu -->
    <rules if="$is_anon">
      <replace css:theme-children=".login-container" css:content="#portal-personaltools-wrapper ul" />
    </rules>
    <rules if-not="$is_anon">
      <drop css:theme=".login-text" />
      <drop css:theme=".login-form" />
      <replace css:theme-children="#portal-personaltools" css:content="#portal-personaltools-wrapper li" />
    </rules>
    <replace css:theme="#personal-menu .user-name" css:content="#portal-personaltools-wrapper dl dt a" />
  </rules>

  <!-- two column layout ex: eu sector policies -->
  <rules css:if-content=".columned">

    <drop css:content=".col-md-9 .tile-default > .tile-content > h2" />
    <drop css:content=".col-md-9 .tile-default > .tile-content > h1" />

    <drop css:content="h1.documentFirstHeading" />
    <before css:content=".content-column > .tile-default:first-child">
      <xsl:copy-of select='//*[@class="documentFirstHeading"]' />
    </before>

    <drop css:content="#viewlet-below-content-title" />
    <before css:content=".content-column > .tile-default:first-child">
      <xsl:copy-of select='//*[@id="viewlet-below-content-title"]' />
    </before>

  </rules>

  <!-- AST & UAST: move last modified under the h1 title -->
  <rules css:if-content=".subsection-tools-adaptation-support-tool">
    <drop css:content="#viewlet-below-content-title" />
    <after css:content=".ast_header > h1">
      <xsl:copy-of select='//*[@id="viewlet-below-content-title"]' />
    </after>
  </rules>

  <rules css:if-content=".subsection-tools-urban-ast">
    <drop css:content="#viewlet-below-content-title" />
    <after css:content=".ast_header > h1">
      <xsl:copy-of select='//*[@id="viewlet-below-content-title"]' />
    </after>
  </rules>

  <!-- UVMB: move h1 title before last modified -->
  <rules css:if-content=".subsection-tools-urban-adaptation-introduction">
    <before css:content="#plone-document-byline">
      <xsl:copy-of select="//*[contains(@class, 'tile-content')]/h1" />
    </before>
    <drop css:content=".tile-content > h1" />
  </rules>

  <!-- move edit bar to the top -->
  <replace css:content="#edit-bar" css:theme="#edit-bar" method="raw"/>
  <drop css:content="#edit-bar" />

  <!-- layout for country profile pages : -->
  <!-- ex. cca/countries-regions/countries/austria  -->
  <rules css:if-content=".subsection-countries .sweet-tabs">

    <drop css:content=".last-update-tile"/>
    <drop css:content="#disclaimer"/>
    <replace css:content=".tab-content">
      <div class="tab-content">
         <xsl:copy-of select='//*[contains(@class,"last-update-tile")]' />
         <xsl:apply-templates select="./*"/>
         <xsl:copy-of select='//*[@id="disclaimer"]' />
      </div>
    </replace>

  </rules>

  <!-- hide pdf button from the main help introduction page -->
  <rules css:if-content=".subsection-index_html">
    <drop css:content="#document-action-download_pdf"/>
  </rules>

  <rules css:if-content=".section-news-archive">
    <drop css:content="#viewlet-below-content > #category"/>
    <after css:content="#viewlet-below-content-body">
      <xsl:copy-of select='//*[contains(@id,"viewlet-below-content")]/*[contains(@id,"category")]' />
    </after>
  </rules>

  <rules css:if-content=".section-more-events">
    <drop css:content="#viewlet-below-content > #category"/>
    <after css:content="#viewlet-below-content-body">
      <xsl:copy-of select='//*[contains(@id,"viewlet-below-content")]/*[contains(@id,"category")]' />
    </after>
  </rules>

  <rules if="contains($host, 'local')">
    <!--<xsl:value-of select="$host" /> shows value of given variable -->
    <after css:theme="footer">
      <script src="/cca/++theme++climateadaptv2/static/js/dev_fixes.js">
      </script>
    </after>
  </rules>


  <xsl:template match="a[@data-linktype = 'external']">
    <a>
      <xsl:copy-of select="@*|b/@*" />
      <xsl:attribute name="href">
        <xsl:value-of select="@data-val" />
      </xsl:attribute>
      <xsl:apply-templates />
    </a>
  </xsl:template>

</rules>
